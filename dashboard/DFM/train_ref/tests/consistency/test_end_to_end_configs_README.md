# train_ref端到端配置测试指南

## 概述

本测试套件使用Playwright MCP验证train_ref模块在12种不同参数配置下的完整训练流程,确保模块在各种合理参数组合下都能稳定运行并产生合理结果。

## 测试策略

**设计理念**: 实用主义 + KISS原则

- 使用Playwright MCP直接测试,无需安装pytest或其他依赖
- 手动执行关键测试用例,记录结果到markdown报告
- 专注于发现实际问题,而非追求100%自动化
- 快速迭代,轻量级维护

## 测试环境

### 前置条件

1. **Streamlit应用运行中**
   ```bash
   python -m streamlit run dashboard/app.py --server.port=8501
   ```

2. **测试数据文件存在**
   ```
   data/经济数据库1017.xlsx
   ```

3. **Playwright MCP可用**
   - 检查`mcp__playwright__*`工具可用
   - 浏览器已安装(使用`mcp__playwright__browser_install`如需要)

### 测试数据配置

- **数据文件**: `data/经济数据库1017.xlsx`
- **开始日期**: 2020-01-01
- **其他data_prep参数**: 默认值
- **预测变量**: 从经济数据库中选择10-12个常用指标

## 测试用例矩阵

共**12个测试用例**,覆盖以下维度:

| 维度 | 取值范围 | 测试用例 |
|-----|---------|---------|
| 因子数(k) | 1, 2, 3, 5, 10, auto | T1-T10 |
| 因子选择方法 | fixed, cumulative, elbow | T1-T8 |
| 变量选择 | 禁用, backward | T1-T8 |
| EM迭代次数 | 10, 30, 50 | T11-T12 |

### 测试用例详情

#### 核心测试(优先执行)

1. **T1: 基线_小因子数**
   - 配置: k=2, fixed, 10变量, 禁用变量选择
   - 目的: 基准测试,验证基本功能

2. **T2: 基线_中因子数**
   - 配置: k=3, fixed, 10变量, 禁用变量选择
   - 目的: 最常用配置验证

3. **T7: 变量选择_固定因子**
   - 配置: k=3, fixed, 12变量, backward变量选择
   - 目的: 验证变量选择功能

#### PCA自动选择测试

4. **T4: PCA_标准阈值**
   - 配置: cumulative(0.85), 10变量
   - 目的: 验证PCA自动选择(85%方差)

5. **T5: PCA_高阈值**
   - 配置: cumulative(0.90), 10变量
   - 目的: 验证PCA高阈值(90%方差)

6. **T6: Elbow方法**
   - 配置: elbow, 10变量
   - 目的: 验证Elbow自动选择

#### 边界测试

7. **T9: 边界_单因子**
   - 配置: k=1, fixed, 10变量
   - 目的: 最小因子数边界

8. **T10: 边界_高维因子**
   - 配置: k=10, fixed, 10变量
   - 目的: 高维因子数边界(k=变量数)

#### 扩展测试

9. **T3: 基线_大因子数** - k=5固定因子
10. **T8: 变量选择_PCA自动** - backward + cumulative(0.85)
11. **T11: EM迭代_少** - 10次迭代(可能未收敛)
12. **T12: EM迭代_多** - 50次迭代(确保收敛)

## 执行流程

### 快速模式(推荐首次执行)

执行3个核心测试用例(T1, T2, T7),预计用时15-20分钟:

```
1. 启动Streamlit应用
2. 通过Claude Code的Playwright MCP执行:
   - T1: k=2, fixed
   - T2: k=3, fixed
   - T7: k=3, fixed + backward变量选择
3. 记录结果到test_results_quick.md
```

### 完整模式

执行所有12个测试用例,预计用时40-50分钟:

```
1. 启动Streamlit应用
2. 按顺序执行所有测试用例
3. 记录结果到test_results_full.md
4. 生成测试摘要报告
```

### 单个测试用例执行步骤

对于每个测试用例:

1. **导航到DFM模块**
   - 访问 http://localhost:8501
   - 点击侧边栏"模型分析"
   - 选择"DFM 模型"

2. **上传数据**
   - 在data_prep tab上传`data/经济数据库1017.xlsx`
   - 设置开始日期为2020-01-01
   - 其他参数保持默认
   - 点击"开始处理"按钮

3. **等待data_prep完成**
   - 观察进度条
   - 确认显示"数据准备完成"

4. **配置模型训练**
   - 切换到"模型训练" tab
   - 选择测试用例指定数量的预测变量
   - 设置训练参数:
     - 因子选择方法
     - 因子数(k)或PCA阈值
     - 变量选择方法
     - EM最大迭代次数

5. **开始训练**
   - 点击"开始训练"按钮
   - 观察训练进度
   - 监控控制台输出(使用Playwright console监控)

6. **记录结果**
   - 训练完成后,记录:
     - 样本外RMSE
     - 样本外Hit Rate
     - 样本外相关系数
     - 选定变量数
     - 选定因子数
     - 训练用时
   - 检查控制台输出:
     - ERROR数量
     - WARNING数量
     - EM收敛信息

7. **验证结果**
   - 检查训练状态为"completed"
   - 验证指标合理性:
     - RMSE > 0
     - Hit Rate ∈ [0, 1]
     - 相关系数 ∈ [-1, 1]
     - 因子数符合配置
   - 检查无控制台ERROR

8. **截图保存**(如有问题)
   - 保存结果摘要截图
   - 保存控制台输出截图

## 结果验证标准

### 通过标准

测试用例通过需满足:

1. **训练成功完成**
   - [x] 状态显示"completed"
   - [x] 无Python异常或崩溃
   - [x] 结果摘要正确展示

2. **结果合理性**
   - [x] RMSE > 0
   - [x] Hit Rate ∈ [0, 1]
   - [x] 相关系数 ∈ [-1, 1]
   - [x] 选定变量数 ≤ 初始变量数
   - [x] 选定因子数符合配置

3. **无控制台ERROR**
   - [x] 控制台无ERROR关键字
   - [x] 无Python异常堆栈
   - [x] EM收敛信息正常

### 失败处理

如果测试用例失败:

1. **记录详细信息**
   - 错误消息
   - 控制台完整输出
   - 页面截图
   - 参数配置

2. **分析问题**
   - 是参数配置错误?
   - 是代码bug?
   - 是数据问题?
   - 是边界情况?

3. **创建Issue**
   - 标题: `[train_ref测试] {测试用例ID}: {问题简述}`
   - 内容: 复现步骤 + 截图 + 日志
   - 优先级: P0(阻塞) / P1(功能) / P2(优化)

## 报告格式

使用`test_end_to_end_configs.py`中的`generate_test_report_template()`生成报告模板。

### 测试摘要报告结构

```markdown
# train_ref端到端配置测试报告

## 执行信息
- 执行时间: YYYY-MM-DD HH:MM
- 执行模式: 快速模式 / 完整模式
- 执行人: [姓名]

## 测试摘要
- 总用例数: 12
- 已执行: X
- 通过: X
- 失败: X
- 跳过: X

## 测试用例详情
[每个用例的详细报告]

## 问题汇总
[发现的问题清单]

## 结论与建议
[总体评估和改进建议]
```

## 预期结果

### 成功场景

所有测试用例应:
- 训练成功完成
- 结果指标在合理范围内
- 无控制台ERROR
- 因子数/变量数符合配置

### 已知边界情况

以下情况可能出现WARNING但不算失败:

1. **T11(EM=10)**: 可能显示"EM未完全收敛"警告
2. **T9(k=1)**: 单因子模型,R²可能较低
3. **T10(k=10)**: 高维因子,可能出现过拟合警告

### 预期发现问题类型

根据之前的快速验证经验,可能发现:

1. **集成问题**: UI组件与train_ref API的集成错误
2. **边界问题**: 极端参数下的数值稳定性问题
3. **性能问题**: 特定配置下训练时间过长
4. **UI问题**: 特定参数组合下的UI交互问题

## 维护与扩展

### 后续扩展方向

1. **增加测试用例**
   - forward变量选择
   - 更多PCA阈值(0.75, 0.80, 0.95)
   - 不同EM收敛容差

2. **自动化升级**
   - 如测试频率增加,可考虑迁移到pytest框架
   - 使用`test_end_to_end_configs.py`作为基础

3. **性能基准**
   - 记录每个配置的训练用时
   - 建立性能基准,监控性能回归

## 参考文件

- `test_end_to_end_configs.py` - 测试用例配置和验证逻辑
- `../../ui_quick/bug_discovery_report.md` - 快速验证测试的Bug发现报告
- `../../ui_quick/test_execution_log.md` - 快速验证测试执行日志

## 联系与支持

如有问题或建议,请:
1. 查看train_ref模块文档: `dashboard/DFM/train_ref/README.md`
2. 查看已知问题: `ui_quick/bug_discovery_report.md`
3. 创建新Issue记录问题
