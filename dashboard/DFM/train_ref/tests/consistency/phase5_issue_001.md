# Phase 5 Issue #001: Kalmanæ»¤æ³¢å™¨æ•°æ®æ ¼å¼ä¸ä¸€è‡´

**å‘ç°æ—¶é—´**: 2025-10-23
**é—®é¢˜çº§åˆ«**: ğŸ”´ **ä¸¥é‡** - é˜»å¡Phase 5æ‰€æœ‰æµ‹è¯•
**çŠ¶æ€**: â¬œ å¾…ä¿®å¤

---

## é—®é¢˜æè¿°

åœ¨Phase 5ç«¯åˆ°ç«¯æµ‹è¯•ä¸­,å‘ç°train_modelå’Œtrain_refçš„Kalmanæ»¤æ³¢å™¨å¯¹è¾“å…¥æ•°æ®Zçš„å½¢çŠ¶æœŸæœ›**å®Œå…¨ç›¸å**,å¯¼è‡´:
- ç¬¬1æ¬¡EMè¿­ä»£åå¹³æ»‘å› å­å°±å‡ºç°å·®å¼‚
- æœ€ç»ˆæ¨¡å‹å‚æ•°å·®å¼‚å·¨å¤§(Lambda: 0.128, A: 0.261, è¿œè¶…1e-10ç›®æ ‡å®¹å·®)

## æ ¹æœ¬åŸå› 

**æ•°æ®å½¢çŠ¶ä¸åŒ¹é…**:

| æ¨¡å— | Zçš„æœŸæœ›å½¢çŠ¶ | ç¤ºä¾‹ | ä»£ç ä½ç½® |
|------|------------|------|----------|
| train_model | `(n_time, n_obs)` | `(50, 10)` | DiscreteKalmanFilter.py:167<br/>`z = np.array(Z.to_numpy())` |
| train_ref | `(n_obs, n_time)` | `(10, 50)` | kalman.py:84<br/>`Z: è§‚æµ‹åºåˆ— (n_obs, n_time)` |

**è°ƒç”¨æ–¹å¼å¯¹æ¯”**:

```python
# train_model (DynamicFactorModel.py:472)
kf = KalmanFilter(
    Z=obs_centered,  # DataFrame (50, 10) â†’ ndarray (50, 10)
    ...
)

# train_ref (factor_model.py:319)
kf = KalmanFilter(...)
result = kf.filter(
    Z=obs_centered.values.T  # DataFrame (50, 10) â†’ ndarray (10, 50)
    ...
)
```

## æ•°å€¼å½±å“

**ç¬¬1æ¬¡EMè¿­ä»£Eæ­¥å¹³æ»‘å› å­**:
```
train_modelç¬¬1æ¬¡: [[-0.03744514  0.36153377]
                     [-0.20065461  2.1039572 ]
                     [ 0.05335588  0.53388721]]

train_refç¬¬1æ¬¡:   [[-0.02372962  0.3868709 ]
                     [-0.21267013  2.0742688 ]
                     [ 0.06846635  0.5436317 ]]
```

**æœ€ç»ˆå‚æ•°å·®å¼‚**:
- Lambdaæœ€å¤§å·®å¼‚: 0.128 (è¶…ç›®æ ‡å®¹å·®1.28e7å€)
- Aæœ€å¤§å·®å¼‚: 0.261
- å¹³æ»‘å› å­æœ€å¤§å·®å¼‚: 1.694

## ä¸Phase 3çš„çŸ›ç›¾

**å›°æƒ‘ç‚¹**: Phase 3çš„Kalmanæ»¤æ³¢å™¨ä¸€è‡´æ€§æµ‹è¯•**å…¨éƒ¨é€šè¿‡(0å·®å¼‚)**,ä¸ºä»€ä¹ˆPhase 5ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜?

**å¯èƒ½åŸå› **:
1. Phase 3çš„æµ‹è¯•å¯èƒ½ä½¿ç”¨äº†ç›¸åŒçš„æ•°æ®æ ¼å¼(éƒ½æ˜¯train_refæ ¼å¼)
2. Phase 3å¯èƒ½æ²¡æœ‰æµ‹è¯•å®Œæ•´çš„train_modelè°ƒç”¨è·¯å¾„
3. Phase 3çš„æ•°æ®å‡†å¤‡æ–¹å¼ä¸Phase 5ä¸åŒ

**éœ€è¦éªŒè¯**: æ£€æŸ¥test_kalman_filter_consistency.pyä¸­çš„æ•°æ®å‡†å¤‡æ–¹å¼

## è§£å†³æ–¹æ¡ˆé€‰é¡¹

### é€‰é¡¹A: ä¿®æ”¹train_refåŒ¹é…train_model (æ¨è)

**ä¼˜ç‚¹**:
- ç¬¦åˆ"train_refä¸train_modelå®Œå…¨ä¸€è‡´"çš„ä»»åŠ¡ç›®æ ‡
- ä¿æŒDataFrame (n_time, n_obs)çš„è‡ªç„¶é¡ºåº

**ç¼ºç‚¹**:
- éœ€è¦ä¿®æ”¹kalman.pyä¸­çš„æ‰€æœ‰ç´¢å¼•é€»è¾‘
- å¯èƒ½å½±å“Phase 3çš„æµ‹è¯•(éœ€è¦å›å½’éªŒè¯)
- å½±å“èŒƒå›´å¤§

**å®æ–½æ­¥éª¤**:
1. ä¿®æ”¹`kalman.py`çš„`filter()`å’Œ`smooth()`æ–¹æ³•,æœŸæœ›Zä¸º(n_time, n_obs)
2. ä¿®æ”¹`factor_model.py`ä¸­çš„è°ƒç”¨,ç§»é™¤`.T`
3. å›å½’è¿è¡ŒPhase 3æ‰€æœ‰æµ‹è¯•
4. é‡æ–°è¿è¡ŒPhase 5æµ‹è¯•

### é€‰é¡¹B: ä¿®æ”¹train_modelåŒ¹é…train_ref

**ä¼˜ç‚¹**:
- train_refçš„è®¾è®¡æ›´ç¬¦åˆçŸ©é˜µæ ‡å‡†è¡¨ç¤º(è§‚æµ‹åœ¨å‰)

**ç¼ºç‚¹**:
- **è¿åä»»åŠ¡ç›®æ ‡**: ä¸åº”è¯¥ä¿®æ”¹train_model
- éœ€è¦ä¿®æ”¹train_modelçš„å¤šä¸ªæ–‡ä»¶
- å½±å“ç°æœ‰ç”Ÿäº§ä»£ç 

**ç»“è®º**: âŒ ä¸æ¨è

### é€‰é¡¹C: åœ¨Phase 5æµ‹è¯•ä¸­è½¬ç½®æ•°æ®

**ä¼˜ç‚¹**:
- ä¸ä¿®æ”¹æ ¸å¿ƒä»£ç 
- å¿«é€ŸéªŒè¯

**ç¼ºç‚¹**:
- **æ²»æ ‡ä¸æ²»æœ¬**: éšè—äº†çœŸå®çš„è®¾è®¡ä¸ä¸€è‡´
- æ— æ³•éªŒè¯ç”Ÿäº§ç¯å¢ƒä¸­çš„çœŸå®è¡Œä¸º
- è¿åtasks.mdçš„ä¸¥æ ¼éªŒè¯è¦æ±‚

**ç»“è®º**: âŒ ä¸å¯æ¥å—

## å†³ç­–

**æ¨è**: **é€‰é¡¹A - ä¿®æ”¹train_refåŒ¹é…train_model**

**ç†ç”±**:
1. ç¬¦åˆopenspecä»»åŠ¡ç›®æ ‡: "train_refå¿…é¡»ä¸train_modelå®Œå…¨ä¸€è‡´"
2. é—®é¢˜æ ¹æºåœ¨train_refçš„è®¾è®¡å†³ç­–
3. å°½ç®¡å½±å“èŒƒå›´å¤§,ä½†è¿™æ˜¯å”¯ä¸€æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **[ ] ç¡®è®¤é€‰é¡¹A**
2. **[ ] ä¿®æ”¹kalman.pyçš„filter()æ–¹æ³•**
   - å°†`Z: (n_obs, n_time)`æ”¹ä¸º`Z: (n_time, n_obs)`
   - ä¿®æ”¹`n_time = Z.shape[1]`ä¸º`n_time = Z.shape[0]`
   - ä¿®æ”¹æ‰€æœ‰æ¶‰åŠZç´¢å¼•çš„ä»£ç 
3. **[ ] ä¿®æ”¹kalman.pyçš„smooth()æ–¹æ³•**
4. **[ ] ä¿®æ”¹factor_model.pyä¸­çš„è°ƒç”¨**
   - ç§»é™¤`Z=obs_centered.values.T`ä¸­çš„`.T`
5. **[ ] å›å½’æµ‹è¯•Phase 3**
   - è¿è¡Œtest_kalman_filter_consistency.py
   - è¿è¡Œtest_kalman_smoother_consistency.py
6. **[ ] é‡æ–°è¿è¡ŒPhase 5æµ‹è¯•**

## é¢„æœŸç»“æœ

ä¿®å¤å,Phase 5æµ‹è¯•åº”è¯¥å‡ºç°:
- ç¬¬1æ¬¡EMè¿­ä»£çš„å¹³æ»‘å› å­å·®å¼‚ < 1e-14
- æœ€ç»ˆå‚æ•°å·®å¼‚ < 1e-10

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-23
**ä¼˜å…ˆçº§**: P0 (æœ€é«˜)
**é˜»å¡**: Phase 5.3, 5.4, 5.5, 5.6, 5.7
